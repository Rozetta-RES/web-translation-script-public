const version="2.6.0";console.log("Rozetta Translation Script Version: v2.6.0");const userKey=document.currentScript.attributes.userkey.value,oriLang=document.currentScript.attributes.lang?document.currentScript.attributes.lang.value:"ja",contractId=document.currentScript.attributes.contractId?document.currentScript.attributes.contractId.value:null,accessKey=document.currentScript.attributes.accessKey?document.currentScript.attributes.accessKey.value:null,secretKey=document.currentScript.attributes.secretKey?document.currentScript.attributes.secretKey.value:null,isRemoveNewLine=!document.currentScript.attributes.isRemoveNewLine||"true"===document.currentScript.attributes.isRemoveNewLine.value,ignoreNodes=document.currentScript.attributes.ignoreNodes?document.currentScript.attributes.ignoreNodes.value:[],isApplyResultToSameText=!!document.currentScript.attributes.isApplyResultToSameText&&"true"===document.currentScript.attributes.isApplyResultToSameText.value,queryPageKeys=document.currentScript.attributes.queryPageKeys?document.currentScript.attributes.queryPageKeys.value:[],isProduction=!!document.currentScript.attributes.isProduction&&"true"===document.currentScript.attributes.isProduction.value,languagesExtension=document.currentScript.attributes.languagesExtension?document.currentScript.attributes.languagesExtension.value:"[]",isDynamicTranslate=!!document.currentScript.attributes.isDynamicTranslate&&"true"===document.currentScript.attributes.isDynamicTranslate.value,isIgnorePath=!!document.currentScript.attributes.isIgnorePath&&"true"===document.currentScript.attributes.isIgnorePath.value,translatedImages=document.currentScript.attributes.translatedImages?document.currentScript.attributes.translatedImages.value:"[]",fieldId=document.currentScript.attributes.fieldId?document.currentScript.attributes.fieldId.value:"1",isAllowPathQuery=!!document.currentScript.attributes.isAllowPathQuery&&"true"===document.currentScript.attributes.isAllowPathQuery.value,TRANSLATION_RESULT_SERVER=isProduction?"https://web-translation-cache.rozetta-api.io":"https://web-translation-staging.rozetta-api.info";let lang,customizedQueryKeys=[];try{customizedQueryKeys=JSON.parse(queryPageKeys)}catch(t){}const fd=async(t,e,a,n)=>{try{const r=await fetch(t,{method:e,headers:{...a,"Cache-Control":"must-revalidate, no-store, no-cache, private"},body:JSON.stringify(n)});return await r.json().then()}catch(t){throw console.log(t),new Error(t)}},ignore={STYLE:0,SCRIPT:0,NOSCRIPT:0,OBJECT:0};let customizedIgnore=[];try{customizedIgnore=JSON.parse(ignoreNodes)}catch(t){}const ttn=(t,e,a=(()=>{}))=>{for(let n of t.childNodes)if(!(n.tagName in ignore)&&!(customizedIgnore.filter((t=>t.tag&&t.tag.toUpperCase()===n.tagName)).length>0||n.id&&customizedIgnore.filter((t=>t.id&&n.id===t.id)).length>0||n.className&&customizedIgnore.filter((t=>t.class&&n.className.toString().includes(t.class))).length>0)){if(n.className&&n.className.toString().includes("rozetta-language-selector"))break;if(n.className&&n.className.toString().includes("rozetta-translator-tool"))break;if(n.className&&n.className.toString().includes("rozetta-translator-editor"))break;switch(n.nodeType){case Node.ELEMENT_NODE:"IMG"===n.tagName&&a(n),ttn(n,e,a);break;case Node.TEXT_NODE:""!==n.nodeValue.replace(/[\n\t\r]/g,"").trim()&&e(n);break;case Node.DOCUMENT_NODE:ttn(n,e,a)}}},rzt=async(t,e)=>{const a=await fd(accessKey&&secretKey?"https://translate.rozetta-api.io/api/v1/token":`${TRANSLATION_RESULT_SERVER}/token?userKey=${userKey}`,accessKey&&secretKey?"POST":"GET",{"Content-Type":"application/json"},accessKey&&secretKey?{accessKey:accessKey,secretKey:secretKey}:void 0);if(accessKey&&secretKey&&"success"!==a.status)return alert("Wrong Keys!"),void $(".rozetta-language-selector-mask").css({display:"none"});const n=a.data.encodedJWT,r=Math.ceil(e.length/100),i=[];for(let t=0;t<r;t++)i.push(e.slice(100*t,Math.min(100*(t+1)),e.length));let o=!1;return(await Promise.all(i.map((async(e,a)=>{let r={fieldId:fieldId,sourceLang:oriLang,targetLang:t,text:e,autoSplit:!1,removeFakeLineBreak:!1};contractId&&(r={...r,contractId:contractId});const i=await fd(`${TRANSLATION_RESULT_SERVER}/api/v1/translate`,"POST",{"Content-Type":"application/json",authorization:`Bearer ${n}`,userKey:userKey},r);return"success"!==i.status&&(o||("This domain is not enabled!"===i.message?alert("\u30a2\u30af\u30bb\u30b9\u304c\u5236\u9650\u3055\u308c\u3066\u3044\u307e\u3059\u3002"):alert(JSON.stringify(i.data)),o=!0),$(".rozetta-language-selector-mask").css({display:"none"})),{order:a,translationResult:i.data.translationResult}})))).sort(((t,e)=>t.order-e.order)).map((t=>t.translationResult)).flat()},glqau=(t,e)=>{let a=null;try{a=new URL(t,`${window.location.origin}${window.location.pathname}`)}catch(t){console.log(t)}if(a&&a.origin===window.location.origin){const t=new URLSearchParams(a.search);if(e&&""!==e){t.get("language");t.set("language",e)}else t.delete("language");if(""===t.toString())return`${a.origin}${a.pathname}${a.hash}`;return`${a.origin}${a.pathname}?${t.toString()}${a.hash}`}return null},initTranslationAsync=async(t=!0)=>{let e=null,a=null,n={},r={};try{e=new URLSearchParams(new URL(document.referrer).search).get("language"),a=new URLSearchParams(window.location.search).get("language")}catch(t){}try{JSON.parse(languagesExtension).map((t=>{n={...n,[t.language]:t.label},r={...r,[t.language]:{translating:t.translatingMessage}}}))}catch(t){console.log(t)}if(null!==e&&null===a&&new URL(document.referrer).pathname!==window.location.pathname&&!isAllowPathQuery){const t=glqau(window.location.href,e);if(t)return location.href=t,!1}if(null!==e&&null===a&&new URL(document.referrer).pathname===window.location.pathname&&customizedQueryKeys.length>0&&!isAllowPathQuery){let t;if(customizedQueryKeys.map((a=>{let n=null,r=null;try{n=new URLSearchParams(new URL(document.referrer).search).get(a),r=new URLSearchParams(window.location.search).get(a)}catch(t){}if(n!==r)return t=glqau(window.location.href,e),!0})).find((t=>t)))return t&&(location.href=t),!1}const i={en:"English",ja:"\u65e5\u672c\u8a9e","zh-CN":"\u7b80\u4f53\u4e2d\u6587","zh-TW":"\u7e41\u9ad4\u4e2d\u6587",th:"\u0e44\u0e17\u0e22",...n},o=new URLSearchParams(window.location.search);let s;try{isAllowPathQuery&&window.location.pathname&&(s=window.location.pathname.split("/").find((t=>Object.keys(i).find((e=>e===t)))))}catch(t){console.log(t)}lang=lang||s||o.get("language")||oriLang;const l={...window.rozetta_systemText,en:{translating:"Translating"},ja:{translating:"\u7ffb\u8a33\u4e2d"},"zh-CN":{translating:"\u6b63\u5728\u7ffb\u8bd1"},"zh-TW":{translating:"\u6b63\u5728\u7ffb\u8b6f"},th:{translating:"\u0e01\u0e33\u0e25\u0e31\u0e07\u0e41\u0e1b\u0e25"},...window.rozetta_systemText,...r};if($(".rozetta-selected-lang").html(i[lang]),t){$("body").append("<style>.rozetta-language-selector { position: fixed;top: 20px;left: 20px;width: 100px;background: rgba(220,220,220,0.8);padding: 10px 0;cursor: pointer;text-align: center; }.rozetta-language-selector:hover .rozetta-language-selector-menu{ display: flex } .rozetta-language-selector:hover .rozetta-language-selector-selected{ display: none } </style>"),$("body").append("<style>.rozetta-language-selector-menu { display: none; flex-direction: column; }</style>"),$("body").append("<style>.rozetta-language-selector-menu-item { width: 100%;box-sizing: border-box;padding: 10px 0;color: rgba(70,95,115,1); }.rozetta-language-selector-menu-item:hover { background: rgba(70,95,115,0.8); color:white; }</style>"),$("body").append("<style>.rozetta-language-selector-mask { position: fixed;top: 0px;left: 0px;width: 100%;height: 100%;z-index:9999;background: rgba(0,0,0,0.5);justify-content: center;align-items: center;color: #fff;font-size: 44px;display:none; }</style>");let t='<div class="rozetta-language-selector-menu">';Object.keys(i).map((e=>t+=`<a class="rozetta-language-selector-menu-item rozetta-language-selector-menu-item-${e}" href="${glqau(window.location.href,e!==oriLang?e:"")}">${i[e]}</a>`)),t+="</div>",$("body").append(`<div class="rozetta-language-selector"><div class="rozetta-language-selector-selected">${i[lang]||i.ja}</div>${t}</div>`),$("body").append(`<div class="rozetta-language-selector-mask">${l[lang||"ja"].translating}<span class="rozetta-language-selector-animation"></span></div>`),Object.keys(i).map((t=>{isAllowPathQuery?$(`.rozetta-language-selector-menu-item-${t}`).attr("href",glqau(window.location.href.split("/").filter((t=>!Object.keys(i).includes(t))).join("/"),t!==oriLang?t:"")):$(`.rozetta-language-selector-menu-item-${t}`).attr("href",glqau(window.location.href,t!==oriLang?t:""))}))}else isDynamicTranslate&&history.pushState&&!o.get("language")&&lang&&lang!==oriLang&&!isAllowPathQuery&&window.history.pushState(window.location.pathname,"",glqau(window.location.href,lang).replace(window.location.origin,""));if(lang&&lang!==oriLang){const t="/translations";isDynamicTranslate||$(".rozetta-language-selector-mask").css({display:"flex"});const e=setInterval((()=>{"..."===$(".rozetta-language-selector-animation").html()?$(".rozetta-language-selector-animation").html(""):$(".rozetta-language-selector-animation").append(".")}),500),a=[],n=[],r=t=>{const e=isRemoveNewLine?t.replace(/[\n\t\r]/g,""):t;isDynamicTranslate&&(!isDynamicTranslate||window.rozettaTranslationResult&&window.rozettaTranslationResult.find((t=>t.translatedText===e.trim()||t.currentModified===e.trim())))||a.push(e.trim())};ttn(document.getElementById("rozetta-translate-from-here")||document.body,(t=>{$(t.parentElement).hasClass("rozetta-translated-node")||$(t.parentElement).addClass("rozetta-translated-node"),r(t.textContent)}),(t=>{!t.src||""===t.src||n.find((e=>e===t.src))||!isDynamicTranslate||window.rozettaTranslationResult&&window.rozettaTranslationResult.find((e=>e.translatedText===t.src||e.currentModified===t.src))||n.push(t.src)}));let i=a,s=!1,l="",c=[],u=[],d=[],g=[],p=[];window.rozettaTranslationResultMaxId||(window.rozettaTranslationResultMaxId=-1);try{if(customizedQueryKeys.map((t=>{o.get(t)&&(l+=`&${t}=${o.get(t)}`)})),i.length>0||n.length>0){const t=await fd(`${TRANSLATION_RESULT_SERVER}/translationTexts/search`,"POST",{"Content-Type":"application/json"},{url:`${isIgnorePath?"/":window.location.pathname}?lang=${lang}${l}`,originalTexts:i.concat(n),userKey:userKey});g=t.translationTexts,Array.isArray(g)||(s=!0,g=[]),window.rozettaTranslationResultMaxId=t.maxTextId,c=c.filter((t=>!g.map((t=>t.textId)).includes(t.id))).concat(g.map((t=>({id:t.textId,text:t.originalText})))),u=u.filter((t=>!g.map((t=>t.textId)).includes(t.id))).concat(g.map((t=>({id:t.textId,text:t.translation})))),d=d.filter((t=>!g.map((t=>t.textId)).includes(t.id))).concat(g.map((t=>({id:t.textId,text:t.property})))),i=i.filter((t=>!g.map((t=>t.originalText)).includes(t))),p=n.filter((t=>!g.map((t=>t.originalText)).includes(t)))}}catch(t){console.log(t),s=!0,p=n}let m=[];if(i.length>0){isDynamicTranslate&&$(".rozetta-language-selector-mask").css({display:"flex",top:"20px",left:"125px",width:"auto",height:"fit-content",background:"transparent",justifyContent:"left",color:"#000",fontSize:"12px"});const t=await rzt(lang,i.filter(((t,e)=>i.indexOf(t)===e)));m=i.map((e=>t.find((t=>t.sourceText===e))))}window.rozettaTranslationResult=[...g.map((t=>({id:t.textId,sourceText:t.originalText,translatedText:t.translation,properties:t.properties,isModified:!0,type:n.find((e=>e===t.originalText))?"img":"text"}))),...m.map((t=>({id:++window.rozettaTranslationResultMaxId,sourceText:t.sourceText,translatedText:t.translatedText,properties:"",isModified:!0,type:"text"}))),...p.map((t=>({id:++window.rozettaTranslationResultMaxId,sourceText:t,translatedText:t,properties:"",isModified:!0,type:"img"}))),...window.rozettaTranslationResult||[]];const y=window.rozettaTranslationResult.map((t=>({id:t.id,text:t.sourceText}))),h=window.rozettaTranslationResult.map((t=>({id:t.id,text:t.translatedText}))),w=window.rozettaTranslationResult.map((t=>({id:t.id,text:t.properties}))),f=(window.location.pathname,s?{url:`${isIgnorePath?"/":window.location.pathname}?lang=${lang}${l}`,userKey:userKey,sourceLang:"ja",targetLang:o.get("language"),originalText:JSON.stringify(y.concat(c.filter((t=>!y.find((e=>e.id===t.id)))))),translation:JSON.stringify(h.concat(u.filter((t=>!h.find((e=>e.id===t.id)))))),properties:JSON.stringify(w.concat(d.filter((t=>!w.find((e=>e.id===t.id))))))}:{url:`${isIgnorePath?"/":window.location.pathname}?lang=${lang}${l}`,userKey:userKey,sourceLang:"ja",targetLang:o.get("language"),originalText:y.concat(c.filter((t=>!y.find((e=>e.id===t.id))))),translation:h.concat(u.filter((t=>!h.find((e=>e.id===t.id))))),properties:w.concat(d.filter((t=>!w.find((e=>e.id===t.id)))))});if(i.length>0||p.length>0)try{fd(s?`${TRANSLATION_RESULT_SERVER}${t}`:`${TRANSLATION_RESULT_SERVER}/translationTexts?url=${encodeURIComponent(`${isIgnorePath?"/":window.location.pathname}?lang=${lang}${l}`)}&userKey=${userKey}`,s?"POST":"PUT",{"Content-Type":"application/json"},f)}catch(t){console.log("Error when update cache",t.message)}let T=!1;const x=[],S=t=>{let e=[];$(t.parentElement).attr("class")&&(e=$(t.parentElement).attr("class").split(/(\s+)/));const a=isRemoveNewLine?t.textContent.replace(/[\n\t\r]/g,""):t.textContent;if(""!==a.trim()&&(e.find((t=>t.includes("rozetta-translated-node")))||isApplyResultToSameText)){const e=window.rozettaTranslationResult.find((t=>t.sourceText===a.trim()&&(!x.includes(t.id)||isApplyResultToSameText)));if(e){if(x.push(e.id),$(t.parentElement).addClass(`rozetta-translate-index-${e.id}`),e.properties&&""!==e.properties){let a="";$(t.parentElement).attr("style")&&(a=$(t.parentElement).attr("style")),$(t.parentElement).css(e.properties)}(!t.className||t.className&&!t.className.toString().includes("rozetta-translator-item-edited"))&&(t.textContent=e.translatedText),e.sourceText!==e.translatedText&&(T=!0)}}};ttn(document.body,(t=>{S(t)}),(t=>{const e=window.rozettaTranslationResult.find((e=>e.sourceText===t.src));e&&($(t).addClass(`rozetta-translate-index-${e.id}`),e.properties&&e.properties,(!t.className||t.className&&!t.className.toString().includes("rozetta-translator-item-edited"))&&(t.src=e.translatedText))})),T&&isDynamicTranslate&&"undefined"!=typeof handleTranslationEditor&&handleTranslationEditor(!1),$(".rozetta-language-selector-mask").css({display:"none"}),clearInterval(e),isDynamicTranslate||$('a:not([href="#"])').not(".rozetta-language-selector-menu-item").on("click",(t=>{if(window.isEditing||!$(t.currentTarget).attr("href"))return!1;{const e=glqau($(t.currentTarget).attr("href"),lang);if(e)return location.href=e,!1}}))}isDynamicTranslate&&(await new Promise((t=>setTimeout(t,1e3))),initTranslationAsync(!1))};$(document).ready((()=>{initTranslationAsync()}));
