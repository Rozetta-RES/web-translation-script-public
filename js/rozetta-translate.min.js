const userKey=document.currentScript.attributes.userkey.value,oriLang=document.currentScript.attributes.lang?document.currentScript.attributes.lang.value:"ja",contractId=document.currentScript.attributes.contractId.value,accessKey=document.currentScript.attributes.accessKey.value,secretKey=document.currentScript.attributes.secretKey.value,isRemoveNewLine=!document.currentScript.attributes.isRemoveNewLine||"true"===document.currentScript.attributes.isRemoveNewLine.value,ignoreNodes=document.currentScript.attributes.ignoreNodes?document.currentScript.attributes.ignoreNodes.value:[],isApplyResultToSameText=!!document.currentScript.attributes.isApplyResultToSameText&&"true"===document.currentScript.attributes.isApplyResultToSameText.value,queryPageKeys=document.currentScript.attributes.queryPageKeys?document.currentScript.attributes.queryPageKeys.value:[],isProduction=!!document.currentScript.attributes.isProduction&&"true"===document.currentScript.attributes.isProduction.value,languagesExtension=document.currentScript.attributes.languagesExtension?document.currentScript.attributes.languagesExtension.value:[],TRANSLATION_RESULT_SERVER=isProduction?"https://web-translation-cache.rozetta-api.io":"https://web-translation-staging.rozetta-api.info";let customizedQueryKeys=[];try{customizedQueryKeys=JSON.parse(queryPageKeys)}catch(e){}const fd=async(e,t,a,n)=>{try{const r=await fetch(e,{method:t,headers:{...a,"Cache-Control":"must-revalidate, no-store, no-cache, private"},body:JSON.stringify(n)});return await r.json().then()}catch(e){throw new Error(e)}},ignore={STYLE:0,SCRIPT:0,NOSCRIPT:0,OBJECT:0};let customizedIgnore=[];try{customizedIgnore=JSON.parse(ignoreNodes)}catch(e){}const ttn=(e,t)=>{for(let a of e.childNodes)if(!(a.tagName in ignore)&&!(customizedIgnore.filter((e=>e.tag&&e.tag.toUpperCase()===a.tagName)).length>0||a.id&&customizedIgnore.filter((e=>e.id&&a.id===e.id)).length>0||a.className&&customizedIgnore.filter((e=>e.class&&a.className.toString().includes(e.class))).length>0)){if(a.className&&a.className.toString().includes("rozetta-language-selector"))break;if(a.className&&a.className.toString().includes("rozetta-translator-tool"))break;if(a.className&&a.className.toString().includes("rozetta-translator-editor"))break;switch(a.nodeType){case Node.ELEMENT_NODE:ttn(a,t);break;case Node.TEXT_NODE:""!==a.nodeValue.replace(/[\n\t\r]/g,"").trim()&&t(a);break;case Node.DOCUMENT_NODE:ttn(a,t)}}},rzt=async(e,t)=>{const a="https://translate.rozetta-api.io",n="/api",r=await fd(`${a}${n}/v1/token`,"POST",{"Content-Type":"application/json"},{accessKey:accessKey,secretKey:secretKey});if("success"!==r.status)return alert("Wrong Keys!"),void $(".rozetta-language-selector-mask").css({display:"none"});const i=r.data.encodedJWT,o=Math.ceil(t.length/100),s=[];for(let e=0;e<o;e++)s.push(t.slice(100*e,Math.min(100*(e+1)),t.length));return(await Promise.all(s.map((async(t,r)=>{const o=await fd(`${a}${n}/v1/translate`,"POST",{"Content-Type":"application/json",Authorization:`Bearer ${i}`},{fieldId:"1",contractId:contractId,sourceLang:oriLang,targetLang:e,text:t,autoSplit:!1,removeFakeLineBreak:!1});return"success"!==o.status&&(alert(JSON.stringify(o.data)),$(".rozetta-language-selector-mask").css({display:"none"})),{order:r,translationResult:o.data.translationResult}})))).sort(((e,t)=>e.order-t.order)).map((e=>e.translationResult)).flat()},glqau=(e,t)=>{let a=null;try{a=new URL(e,`${window.location.origin}${window.location.pathname}`)}catch(e){console.log(e)}if(a&&a.origin===window.location.origin){const e=new URLSearchParams(a.search);if(t||""!==t){e.get("language");e.set("language",t)}else e.delete("language");return`${a.origin}${a.pathname}?${e.toString()}${a.hash}`}return null},initAsync=async()=>{let e=null,t=null,a={},n={};try{e=new URLSearchParams(new URL(document.referrer).search).get("language"),t=new URLSearchParams(window.location.search).get("language")}catch(e){}try{JSON.parse(languagesExtension).map((e=>{a={...a,[e.language]:e.label},n={...n,[e.language]:{translating:e.translatingMessage}}}))}catch(e){console.log(e)}if(null!==e&&null===t&&new URL(document.referrer).pathname!==window.location.pathname){const t=glqau(window.location.href,e);if(t)return location.href=t,!1}if(null!==e&&null===t&&new URL(document.referrer).pathname===window.location.pathname&&customizedQueryKeys.length>0){let t;if(customizedQueryKeys.map((a=>{let n=null,r=null;try{n=new URLSearchParams(new URL(document.referrer).search).get(a),r=new URLSearchParams(window.location.search).get(a)}catch(e){}if(n!==r)return t=glqau(window.location.href,e),!0})).find((e=>e)))return t&&(location.href=t),!1}const r=new URLSearchParams(window.location.search),i=r.get("language")||oriLang,o={en:"English",ja:"\u65e5\u672c\u8a9e","zh-CN":"\u7b80\u4f53\u4e2d\u6587","zh-TW":"\u7e41\u9ad4\u4e2d\u6587",th:"\u0e44\u0e17\u0e22",...a},s={en:{translating:"Translating"},ja:{translating:"\u7ffb\u8a33\u4e2d"},"zh-CN":{translating:"\u6b63\u5728\u7ffb\u8bd1"},"zh-TW":{translating:"\u6b63\u5728\u7ffb\u8b6f"},th:{translating:"\u0e01\u0e33\u0e25\u0e31\u0e07\u0e41\u0e1b\u0e25"},...window.rozetta_systemText,...n};$(".rozetta-selected-lang").html(o[i]),$("body").append("<style>.rozetta-language-selector { position: fixed;top: 20px;left: 20px;width: 100px;background: rgba(220,220,220,0.8);padding: 10px 0;cursor: pointer;text-align: center; z-index: 99999; }.rozetta-language-selector:hover .rozetta-language-selector-menu{ display: flex } .rozetta-language-selector:hover .rozetta-language-selector-selected{ display: none } </style>"),$("body").append("<style>.rozetta-language-selector-menu { display: none; flex-direction: column; }</style>"),$("body").append("<style>.rozetta-language-selector-menu-item { width: 100%;box-sizing: border-box;padding: 10px 0;color: rgba(70,95,115,1); }.rozetta-language-selector-menu-item:hover { background: rgba(70,95,115,0.8); color:white; }</style>"),$("body").append("<style>.rozetta-language-selector-mask { position: fixed;top: 0px;left: 0px;width: 100%;height: 100%;z-index:99999;background: rgba(0,0,0,0.5);justify-content: center;align-items: center;color: #fff;font-size: 44px;display:none; }</style>");let l='<div class="rozetta-language-selector-menu">';if(Object.keys(o).map((e=>l+=`<a class="rozetta-language-selector-menu-item "href="${glqau(window.location,e!==oriLang?e:"")}">${o[e]}</a>`)),l+="</div>",$("body").append(`<div class="rozetta-language-selector"><div class="rozetta-language-selector-selected">${o[i]||o.ja}</div>${l}</div>`),$("body").append(`<div class="rozetta-language-selector-mask">${s[i||"ja"].translating}<span class="rozetta-language-selector-animation"></span></div>`),i&&i!==oriLang){const e="/translations";$(".rozetta-language-selector-mask").css({display:"flex"});const t=setInterval((()=>{"..."===$(".rozetta-language-selector-animation").html()?$(".rozetta-language-selector-animation").html(""):$(".rozetta-language-selector-animation").append(".")}),500),a=[],n=e=>{const t=isRemoveNewLine?e.replace(/[\n\t\r]/g,""):e;""!==t.trim()&&a.push(t.trim())};ttn(document.getElementById("rozetta-translate-from-here")||document.body,(e=>{$(e.parentElement).addClass("rozetta-translated-node"),n(e.textContent)}));let o=[],s=a,l=[],c=[],d=!1,u="";try{customizedQueryKeys.map((e=>{r.get(e)&&(u+=`&${e}=${r.get(e)}`)}));const t=await fd(`${TRANSLATION_RESULT_SERVER}${e}?url=${encodeURIComponent(`${window.location.pathname}?lang=${i}${u}`)}&userKey=${userKey}`,"GET",{"Content-Type":"application/json"});let n=-1;try{JSON.parse(t.originalText).map((e=>e.id)).length>0&&(n=Math.max(...JSON.parse(t.originalText).map((e=>e.id))))}catch(e){}const d=[];o=a.map((e=>{if(JSON.parse(t.originalText).find((t=>t.text===e))){const a=JSON.parse(t.originalText).find((t=>t.text===e&&!d.includes(t.id)));if(a)return d.push(a.id),s=s.filter((t=>t!==e)),l.push(JSON.parse(t.translation).find((e=>e.id===a.id))),c.push(JSON.parse(t.properties).find((e=>e.id===a.id))),{id:`${a.id}`,text:e};if(JSON.parse(t.originalText).find((t=>t.text===e))){n++;const a=JSON.parse(t.originalText).find((t=>t.text===e));return l.push({...JSON.parse(t.translation).find((e=>e.id===a.id)),id:`${n}`}),{id:`${n}`,text:e}}return null}return n++,{id:`${n}`,text:e}})),o=o.filter((e=>e))}catch(e){d=!0;let t=-1;o=a.map((e=>(t++,{id:`${t}`,text:e})))}let g=[];if(s.length>0){const e=await rzt(i,s.filter(((e,t)=>s.indexOf(e)===t)));g=s.map((t=>e.find((e=>e.sourceText===t))))}window.rozettaTranslationResult=o.map((e=>l.find((t=>t.id===e.id))?{id:e.id,sourceText:e.text,translatedText:l.find((t=>t.id===e.id)).text,properties:c.find((t=>t&&t.id===e.id))?c.find((t=>t&&t.id===e.id)).text:"",isModified:!0}:{id:e.id,sourceText:e.text,translatedText:g.find((t=>t.sourceText===e.text)).translatedText,properties:"",isModified:!1}));const p=window.rozettaTranslationResult.map((e=>({id:e.id,text:e.sourceText}))),m=window.rozettaTranslationResult.map((e=>({id:e.id,text:e.translatedText}))),y=window.rozettaTranslationResult.map((e=>({id:e.id,text:e.properties}))),h=(window.location.pathname,{url:`${window.location.pathname}?lang=${i}${u}`,userKey:userKey,sourceLang:"ja",targetLang:r.get("language"),originalText:JSON.stringify(p),translation:JSON.stringify(m),properties:JSON.stringify(y)});if(s.length>0){await fd(d?`${TRANSLATION_RESULT_SERVER}${e}`:`${TRANSLATION_RESULT_SERVER}${e}?url=${encodeURIComponent(`${window.location.pathname}?lang=${i}${u}`)}&userKey=${userKey}`,d?"POST":"PUT",{"Content-Type":"application/json"},h)}const f=[],w=e=>{let t=[];$(e.parentElement).attr("class")&&(t=$(e.parentElement).attr("class").split(/(\s+)/));const a=isRemoveNewLine?e.textContent.replace(/[\n\t\r]/g,""):e.textContent;if(""!==a.trim()&&(t.find((e=>e.includes("rozetta-translated-node")))||isApplyResultToSameText)){const t=window.rozettaTranslationResult.find((e=>e.sourceText===a.trim()&&(!f.includes(e.id)||isApplyResultToSameText)));if(t){if(f.push(t.id),$(e.parentElement).addClass(`rozetta-translate-index-${t.id}`),t.properties&&""!==t.properties){let a="";$(e.parentElement).attr("style")&&(a=$(e.parentElement).attr("style")),$(e.parentElement).css(t.properties)}e.textContent=t.translatedText}}};ttn(document.body,(e=>{w(e)})),$(".rozetta-language-selector-mask").css({display:"none"}),clearInterval(t),$('a:not([href="#"])').not(".rozetta-language-selector-menu-item").on("click",(e=>{if(window.isEditing||!$(e.currentTarget).attr("href"))return!1;{const t=glqau($(e.currentTarget).attr("href"),i);if(t)return location.href=t,!1}}))}};$(document).ready((()=>{initAsync()}));
